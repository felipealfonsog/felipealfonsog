name: Spotify Telemetry (CLI feed)

on:
  workflow_dispatch:
  schedule:
    # ------------------------------------------------------------
    # NORMAL CRON (baseline / “como antes”)
    # - Siempre corre cada 3h, pase lo que pase
    # ------------------------------------------------------------
    - cron: "23 */3 * * *"

    # ------------------------------------------------------------
    # FAST POLL (cada 1 minuto)
    # - Solo dispara 1 vez cuando detecta playback
    # - Con latch: NO repite mientras siga la misma sesión
    # ------------------------------------------------------------
    - cron: "* * * * *"

permissions:
  contents: write

env:
  # ------------------------------------------------------------
  # Toggle maestro del fast poll
  # true  => habilita cron 1m + guard + latch
  # false => cron 1m se vuelve no-op, cron 3h sigue normal
  # ------------------------------------------------------------
  ENABLE_FAST_POLL: "true"        # true/false

  # ------------------------------------------------------------
  # Modo fast poll
  # PLAYING_ONLY => requiere is_playing=true
  # ANY_SESSION  => requiere sesión activa (device existe)
  # ------------------------------------------------------------
  FAST_POLL_MODE: "PLAYING_ONLY"  # PLAYING_ONLY | ANY_SESSION

  # ------------------------------------------------------------
  # Latch state file (persistido en el repo)
  # ------------------------------------------------------------
  LATCH_FILE: ".github/state/spotify_fastpoll_latch.json"

jobs:
  telemetry:
    runs-on: ubuntu-latest
    steps:
      # ------------------------------------------------------------
      # Checkout
      # ------------------------------------------------------------
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # ------------------------------------------------------------
      # Python runtime
      # ------------------------------------------------------------
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      # ------------------------------------------------------------
      # Guard + Latch (decide si este run debe ejecutar o no)
      # - Normal (3h): siempre allow
      # - Fast (1m): allow solo si detecta playback y latch armado
      # ------------------------------------------------------------
      - name: Guard (fast poll + latch)
        id: guard
        env:
          EVENT_NAME: ${{ github.event_name }}
          SCHEDULE_CRON: ${{ github.event.schedule }}
          ENABLE_FAST_POLL: ${{ env.ENABLE_FAST_POLL }}
          FAST_POLL_MODE: ${{ env.FAST_POLL_MODE }}
          LATCH_FILE: ${{ env.LATCH_FILE }}
          SPOTIFY_CLIENT_ID: ${{ secrets.SPOTIFY_CLIENT_ID }}
          SPOTIFY_CLIENT_SECRET: ${{ secrets.SPOTIFY_CLIENT_SECRET }}
          SPOTIFY_REFRESH_TOKEN: ${{ secrets.SPOTIFY_REFRESH_TOKEN }}
        run: |
          set -euo pipefail
          python3 .github/scripts/spotify_fastpoll_guard.py

      # ------------------------------------------------------------
      # Commit latch (solo si cambió)
      # - Hace durable el “solo una vez por sesión”
      # ------------------------------------------------------------
      - name: Commit latch state (if changed)
        if: steps.guard.outputs.changed_latch == 'true'
        run: |
          set -euo pipefail
          if git diff --quiet; then
            echo "No latch changes."
            exit 0
          fi
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add .github/state/spotify_fastpoll_latch.json
          git commit -m "chore: fast-poll latch update"
          git push

      # ------------------------------------------------------------
      # Update telemetry (solo si guard dijo true)
      # ------------------------------------------------------------
      - name: Update Spotify telemetry block (fail-safe)
        if: steps.guard.outputs.should_run == 'true'
        env:
          SPOTIFY_CLIENT_ID: ${{ secrets.SPOTIFY_CLIENT_ID }}
          SPOTIFY_CLIENT_SECRET: ${{ secrets.SPOTIFY_CLIENT_SECRET }}
          SPOTIFY_REFRESH_TOKEN: ${{ secrets.SPOTIFY_REFRESH_TOKEN }}
        run: |
          set -euo pipefail
          python3 .github/scripts/spotify_telemetry.py

      # ------------------------------------------------------------
      # Commit & push (solo si guard dijo true)
      # ------------------------------------------------------------
      - name: Commit & push if changed
        if: steps.guard.outputs.should_run == 'true'
        run: |
          set -euo pipefail
          if git diff --quiet; then
            echo "No changes."
            exit 0
          fi
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add README.md .github/state/spotify_last_report.json
          git commit -m "chore: update Spotify telemetry (CLI feed)"
          git push
