name: Spotify Telemetry (CLI feed) 
# v2.9

on:
  workflow_dispatch:
  schedule:
    # ------------------------------------------------------------
    # BASELINE (cada 3 horas, minuto 23)
    # - 8 runs/dÃ­a
    # - Estable / predecible / sin polling agresivo
    # ------------------------------------------------------------
    - cron: "23 */3 * * *"

permissions:
  contents: write

concurrency:
  group: spotify-telemetry
  cancel-in-progress: false

jobs:
  telemetry:
    runs-on: ubuntu-latest
    steps:
      # ------------------------------------------------------------
      # Checkout
      # ------------------------------------------------------------
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # ------------------------------------------------------------
      # Python runtime
      # ------------------------------------------------------------
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      # ------------------------------------------------------------
      # Update telemetry (script debe ser idempotente)
      # ------------------------------------------------------------
      - name: Update Spotify telemetry block
        env:
          SPOTIFY_CLIENT_ID: ${{ secrets.SPOTIFY_CLIENT_ID }}
          SPOTIFY_CLIENT_SECRET: ${{ secrets.SPOTIFY_CLIENT_SECRET }}
          SPOTIFY_REFRESH_TOKEN: ${{ secrets.SPOTIFY_REFRESH_TOKEN }}
        run: |
          set -euo pipefail
          python3 .github/scripts/spotify_telemetry.py

      # ------------------------------------------------------------
      # Commit & push ONLY if changed
      # ------------------------------------------------------------
      - name: Commit & push telemetry if changed
        run: |
          set -euo pipefail

          if git diff --quiet; then
            echo "No telemetry changes."
            exit 0
          fi

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Ajusta paths si tu script toca otros archivos
          git add README.md .github/state/spotify_last_report.json 2>/dev/null || true
          git add README.md 2>/dev/null || true

          if git diff --cached --quiet; then
            echo "Nothing staged after add (unexpected)."
            exit 0
          fi

          git commit -m "chore: update Spotify telemetry (CLI feed)"
          git push

      # ------------------------------------------------------------
      # Optional debug artifact (if your script writes it)
      # ------------------------------------------------------------
      - name: Upload Spotify debug (optional)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: spotify-debug
          path: .github/state/spotify_debug.json
          if-no-files-found: ignore
