name: Spotify Telemetry (CLI feed)

on:
  workflow_dispatch:
  schedule:
    # ------------------------------------------------------------
    # NORMAL CRON (baseline, “como antes”)
    # - Se ejecuta siempre cada 3h, pase lo que pase
    # ------------------------------------------------------------
    - cron: "23 */3 * * *"

    # ------------------------------------------------------------
    # FAST POLL (cada 1 minuto)
    # - Solo intenta disparar cuando detecta playback
    # - Con latch + cooldown: dispara 1 vez y luego se calla
    # ------------------------------------------------------------
    - cron: "* * * * *"

permissions:
  contents: write

env:
  # ------------------------------------------------------------
  # Toggle maestro del fast poll
  # true  => habilita fast poll + guard
  # false => fast poll se vuelve no-op, pero el cron 3h sigue normal
  # ------------------------------------------------------------
  ENABLE_FAST_POLL: "true"        # true/false

  # ------------------------------------------------------------
  # Modo de decisión del fast poll
  # PLAYING_ONLY => requiere playback real (is_playing=true)
  # ANY_SESSION  => basta con sesión/dispositivo activo
  # ------------------------------------------------------------
  FAST_POLL_MODE: "PLAYING_ONLY"  # PLAYING_ONLY | ANY_SESSION

  # ------------------------------------------------------------
  # Latch state en el repo (persistente)
  # ------------------------------------------------------------
  LATCH_FILE: ".github/state/spotify_fastpoll_latch.json"

  # ------------------------------------------------------------
  # Anti-stuck: si el latch queda “false” para siempre,
  # se rearma automáticamente después de X minutos.
  # ------------------------------------------------------------
  LATCH_COOLDOWN_MINUTES: "20"

jobs:
  telemetry:
    runs-on: ubuntu-latest
    steps:
      # ------------------------------------------------------------
      # Checkout
      # ------------------------------------------------------------
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # ------------------------------------------------------------
      # Python runtime
      # ------------------------------------------------------------
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      # ------------------------------------------------------------
      # Decide si este run debe proceder o no
      #
      # - Cron 3h: SIEMPRE corre (comportamiento original)
      # - Cron 1m: corre solo si guard dice should_run=true
      # ------------------------------------------------------------
      - name: Guard decision (fast poll + latch)
        id: guard
        env:
          ENABLE_FAST_POLL: ${{ env.ENABLE_FAST_POLL }}
          FAST_POLL_MODE: ${{ env.FAST_POLL_MODE }}
          LATCH_FILE: ${{ env.LATCH_FILE }}
          LATCH_COOLDOWN_MINUTES: ${{ env.LATCH_COOLDOWN_MINUTES }}
          SPOTIFY_CLIENT_ID: ${{ secrets.SPOTIFY_CLIENT_ID }}
          SPOTIFY_CLIENT_SECRET: ${{ secrets.SPOTIFY_CLIENT_SECRET }}
          SPOTIFY_REFRESH_TOKEN: ${{ secrets.SPOTIFY_REFRESH_TOKEN }}
        run: |
          set -euo pipefail

          EVENT="${{ github.event_name }}"
          SCHEDULE="${{ github.event.schedule || '' }}"

          # Default: allow (cron 3h + manual)
          SHOULD_RUN="true"
          REASON="normal_or_manual"
          CHANGED="false"

          FAST_CRON="* * * * *"

          # Solo aplicar guard en fast poll schedule
          if [ "${EVENT}" = "schedule" ] && [ "${SCHEDULE}" = "${FAST_CRON}" ]; then
            python3 .github/scripts/spotify_fastpoll_guard.py > /tmp/guard.txt
            cat /tmp/guard.txt

            SHOULD_RUN="$(grep -E '^should_run=' /tmp/guard.txt | tail -n1 | cut -d= -f2)"
            REASON="$(grep -E '^reason=' /tmp/guard.txt | tail -n1 | cut -d= -f2)"
            CHANGED="$(grep -E '^changed_latch=' /tmp/guard.txt | tail -n1 | cut -d= -f2)"
            rm -f /tmp/guard.txt
          fi

          echo "should_run=${SHOULD_RUN}" >> "$GITHUB_OUTPUT"
          echo "reason=${REASON}" >> "$GITHUB_OUTPUT"
          echo "changed_latch=${CHANGED}" >> "$GITHUB_OUTPUT"
          echo "event=${EVENT}" >> "$GITHUB_OUTPUT"
          echo "schedule=${SCHEDULE}" >> "$GITHUB_OUTPUT"

          echo "Decision: should_run=${SHOULD_RUN} reason=${REASON} changed_latch=${CHANGED} (event=${EVENT}, schedule=${SCHEDULE})"

      # ------------------------------------------------------------
      # Commit latch si cambió (persistencia del “solo una vez”)
      # ------------------------------------------------------------
      - name: Commit latch state (if changed)
        if: steps.guard.outputs.changed_latch == 'true'
        run: |
          set -euo pipefail
          if git diff --quiet; then
            echo "No latch changes."
            exit 0
          fi
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add .github/state/spotify_fastpoll_latch.json
          git commit -m "chore: fast-poll latch update"
          git push

      # ------------------------------------------------------------
      # Actualiza telemetría solo si corresponde
      # ------------------------------------------------------------
      - name: Update Spotify telemetry block (fail-safe)
        if: steps.guard.outputs.should_run == 'true'
        env:
          SPOTIFY_CLIENT_ID: ${{ secrets.SPOTIFY_CLIENT_ID }}
          SPOTIFY_CLIENT_SECRET: ${{ secrets.SPOTIFY_CLIENT_SECRET }}
          SPOTIFY_REFRESH_TOKEN: ${{ secrets.SPOTIFY_REFRESH_TOKEN }}
        run: |
          set -euo pipefail
          python3 .github/scripts/spotify_telemetry.py

      # ------------------------------------------------------------
      # Commit README/state si hubo cambios
      # ------------------------------------------------------------
      - name: Commit & push if changed
        if: steps.guard.outputs.should_run == 'true'
        run: |
          set -euo pipefail
          if git diff --quiet; then
            echo "No changes."
            exit 0
          fi
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add README.md .github/state/spotify_last_report.json
          git commit -m "chore: update Spotify telemetry (CLI feed)"
          git push
