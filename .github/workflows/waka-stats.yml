import base64, json, re, urllib.request, os, math

API_KEY = os.environ["WAKATIME_API_KEY"]
auth = base64.b64encode(f"{API_KEY}:".encode()).decode()

BLOCKS = "○●◔◕◐◕◔◐●◔◐◕"
BAR_LEN = 20

def get(url):
    req = urllib.request.Request(
        url,
        headers={"Authorization": f"Basic {auth}"}
    )
    with urllib.request.urlopen(req) as r:
        return json.load(r)

def bar(pct):
    filled = int(round(pct / 100 * BAR_LEN))
    return BLOCKS[-1] * filled + BLOCKS[0] * (BAR_LEN - filled)

stats = get("https://wakatime.com/api/v1/users/current/stats/all_time")["data"]
total_seconds = stats["total_seconds"]

def section(title, items):
    out = f"### {title}\n\n"
    for i in items:
        pct = (i["total_seconds"] / total_seconds) * 100
        out += (
            f"{i['name']:<12} "
            f"{i['text']:<15} "
            f"{bar(pct)} "
            f"{pct:5.2f} %\n"
        )
    return out + "\n"

content = (
    "## WakaTime Stats\n\n"
    f"**Total Time:** {stats['human_readable_total']}\n\n"
    + section("Operating Systems", stats.get("operating_systems", []))
    + section("Editors", stats.get("editors", []))
)

with open("README.md", "r", encoding="utf-8") as f:
    readme = f.read()

new = re.sub(
    r"<!--START_SECTION:wakastats-->.*?<!--END_SECTION:wakastats-->",
    f"<!--START_SECTION:wakastats-->\n{content}\n<!--END_SECTION:wakastats-->",
    readme,
    flags=re.S
)

with open("README.md", "w", encoding="utf-8") as f:
    f.write(new)
